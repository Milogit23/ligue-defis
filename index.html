<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ligue des D√©fis</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  display: flex;
  justify-content: center;
  padding: 20px;
}
.container {
  max-width: 650px;
  width: 100%;
  background: #1c1c1c;
  padding: 20px;
  border-radius: 10px;
}
h1, h2 { text-align: center; }
.player {
  background: #2a2a2a;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.player:hover { background: #333; }
.history {
  margin-top: 8px;
  background: #1a1a1a;
  border-radius: 6px;
  padding: 6px;
}
.history table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.history th, .history td {
  padding: 5px;
  border-bottom: 1px solid #333;
  text-align: center;
}
form input, form select, form button {
  width: 100%;
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 5px;
  border: none;
}
form button { background: #2ecc71; font-weight: bold; cursor: pointer; }
.nameInput { width: 60%; padding: 5px; border-radius: 5px; border: none; }
.renameBtn { padding: 5px 10px; margin-left: 5px; border: none; border-radius: 5px; background: #3498db; cursor: pointer; }
.renameBtn:hover { opacity: 0.8; }
.deleteBtn { padding: 5px 10px; margin-left: 5px; border: none; border-radius: 5px; background: #e74c3c; cursor: pointer; }
.deleteBtn:hover { opacity: 0.8; }
</style>
</head>
<body>

<div class="container">
  <h1>üèÜ Ligue des D√©fis</h1>

  <div id="players"></div>

  <h2>‚ûï Nouveau d√©fi</h2>
  <form onsubmit="addChallenge(event)">
    <select id="playerSelect"></select>
    <input id="challengeName" placeholder="Nom du d√©fi" required>
    <input id="rate" type="number" step="0.5" placeholder="Points par action (ex : 0.5)" required>
    <input id="count" type="number" placeholder="Nombre r√©ussi" required>
    <button>Valider le d√©fi</button>
  </form>

  <h2>‚ûï Ajouter un joueur</h2>
  <form onsubmit="addPlayer(event)">
    <input id="newPlayerName" placeholder="Nom du joueur" required>
    <button>Ajouter joueur</button>
  </form>
</div>

<script>
let players = JSON.parse(localStorage.getItem("players")) || [
  { name: "Milo", score: 0 },
  { name: "Joueur 2", score: 0 },
  { name: "Joueur 3", score: 0 },
  { name: "Joueur 4", score: 0 }
];

let history = JSON.parse(localStorage.getItem("history")) || [];
let openedPlayer = null;

function save() {
  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("history", JSON.stringify(history));
}

function render() {
  players.sort((a, b) => b.score - a.score);

  const container = document.getElementById("players");
  const select = document.getElementById("playerSelect");

  container.innerHTML = "";
  select.innerHTML = "";

  players.forEach((p, index) => {
    select.innerHTML += `<option value="${p.name}">${p.name}</option>`;

    const div = document.createElement("div");
    div.className = "player";

    div.innerHTML = `
      <div style="display:flex; align-items:center;">
        <strong>${index + 1}. </strong>
        <input class="nameInput" value="${p.name}" onchange="renamePlayer(${index}, this.value)">
        ‚Äî ${p.score} pts
      </div>
      <div>
        <button class="deleteBtn" onclick="deletePlayer(${index}, event)">Supprimer</button>
      </div>
    `;

    div.onclick = (e) => {
      if (e.target.classList.contains("nameInput") || e.target.classList.contains("deleteBtn")) return;
      toggleHistory(p.name, div);
    }

    if (openedPlayer === p.name) {
      div.appendChild(renderHistory(p.name));
    }

    container.appendChild(div);
  });

  save();
}

function renamePlayer(index, newName) {
  if (!newName.trim()) return;
  const oldName = players[index].name;
  players[index].name = newName.trim();
  history.forEach(h => {
    if (h.player === oldName) h.player = newName.trim();
  });
  render();
}

function deletePlayer(index, event) {
  event.stopPropagation();
  if (!confirm(`Supprimer ${players[index].name} et tous ses d√©fis ?`)) return;
  const name = players[index].name;
  players.splice(index,1);
  history = history.filter(h => h.player !== name);
  if (openedPlayer === name) openedPlayer = null;
  render();
}

function renderHistory(playerName) {
  const div = document.createElement("div");
  div.className = "history";

  const rows = history.filter(h => h.player === playerName);

  if (rows.length === 0) {
    div.innerHTML = "<em>Aucun d√©fi enregistr√©</em>";
    return div;
  }

  let html = `
    <table>
      <tr>
        <th>D√©fi</th>
        <th>Bar√®me</th>
        <th>R√©alis√©</th>
        <th>Points</th>
        <th>Action</th>
      </tr>
  `;

  rows.forEach((h, i) => {
    html += `
      <tr>
        <td>${h.challenge}</td>
        <td>${h.rate}</td>
        <td>${h.count}</td>
        <td>${h.points}</td>
        <td><button class="deleteBtn" onclick="deleteChallenge(${i}, event)">Supprimer</button></td>
      </tr>
    `;
  });

  html += "</table>";
  div.innerHTML = html;
  return div;
}

function deleteChallenge(index, event) {
  event.stopPropagation();
  if (!confirm("Supprimer ce d√©fi ?")) return;
  const removed = history.splice(index,1)[0];
  const player = players.find(p => p.name === removed.player);
  player.score -= removed.points;
  player.score = Math.round(player.score*2)/2;
  render();
}

function toggleHistory(name) {
  openedPlayer = openedPlayer === name ? null : name;
  render();
}

function addChallenge(e) {
  e.preventDefault();
  const playerName = playerSelect.value;
  const challenge = challengeName.value;
  const rate = parseFloat(rateInput.value);
  const count = parseInt(countInput.value);
  const points = Math.round(rate * count * 2) / 2;

  const player = players.find(p => p.name === playerName);
  player.score += points;

  history.unshift({ player: playerName, challenge, rate, count, points });

  e.target.reset();
  render();
}

function addPlayer(e) {
  e.preventDefault();
  const name = document.getElementById("newPlayerName").value.trim();
  if (!name) return;
  players.push({ name, score:0 });
  document.getElementById("newPlayerName").value = "";
  render();
}

const rateInput = document.getElementById("rate");
const countInput = document.getElementById("count");

render();
</script>

</body>
</html>
